<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen Interactivo de C#</title>
    <!-- Incluimos Tailwind CSS para los estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Usamos la fuente Inter, como es habitual */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para las opciones de radio */
        .radio-label:has(:checked) {
            background-color: #eff6ff; /* bg-blue-50 */
            border-color: #3b82f6; /* border-blue-500 */
        }
        
        /* Estilos para el modal de explicaci√≥n de Gemini */
        #explanation-modal {
            background-color: rgba(0, 0, 0, 0.5); /* Fondo oscuro semitransparente */
            transition: opacity 0.3s ease;
        }
        #explanation-modal-content {
            transition: all 0.3s ease;
        }
        /* Estilos para el spinner de carga */
        .loader {
            border: 4px solid #f3f3f3; /* Gris claro */
            border-top: 4px solid #3b82f6; /* Azul */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-2xl shadow-xl">
        
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-700">Examen Interactivo de C#</h1>
            <p class="text-lg text-gray-600 mt-2">Pon a prueba tus conocimientos en C#</p>

            <!-- 
                Se ha eliminado el campo de entrada de la API Key. 
                La clave que proporcionaste est√° ahora incrustada directamente en el script de abajo.
                ADVERTENCIA: Esto no es seguro si compartes este archivo.
            -->
        </header>

        <!-- Navegaci√≥n de Pesta√±as -->
        <nav class="flex border-b border-gray-300" aria-label="Tabs">
            <button class="tab-button active-tab" data-target="basic-quiz">
                Nivel B√°sico
            </button>
            <button class="tab-button" data-target="intermediate-quiz">
                Nivel Intermedio
            </button>
            <button class="tab-button" data-target="advanced-quiz">
                Nivel Avanzado
            </button>
            <!-- NUEVA PESTA√ëA DE IA -->
            <button class="tab-button" data-target="ai-quiz">
                ü§ñ Generado por IA
            </button>
        </nav>

        <!-- El formulario contendr√° todas las preguntas -->
        <form id="quiz-form">
            
            <!-- Contenedores de Pesta√±as -->
            <div id="basic-quiz" class="tab-content py-6 space-y-8">
                <!-- Las preguntas b√°sicas se cargar√°n aqu√≠ -->
            </div>

            <div id="intermediate-quiz" class="tab-content py-6 space-y-8 hidden">
                <!-- Las preguntas intermedias se cargar√°n aqu√≠ -->
            </div>

            <div id="advanced-quiz" class="tab-content py-6 space-y-8 hidden">
                <!-- Las preguntas avanzadas se cargar√°n aqu√≠ -->
            </div>

            <!-- NUEVO CONTENEDOR DE PESTA√ëA DE IA -->
            <div id="ai-quiz" class="tab-content py-6 space-y-8 hidden">
                <!-- El loader se muestra hasta que la IA responda -->
                <div id="ai-quiz-loader" class="flex flex-col items-center justify-center p-12 text-gray-500">
                    <div class="loader"></div>
                    <p class="mt-4 text-lg">Generando 5 preguntas nuevas con IA...</p>
                    <p class="text-sm">(Esto solo sucede la primera vez que abres esta pesta√±a)</p>
                </div>
                <!-- Las preguntas generadas por IA se cargar√°n aqu√≠ -->
            </div>

            <!-- Bot√≥n de Env√≠o -->
            <button type="submit" class="w-full mt-10 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-all duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300">
                Enviar Respuestas y Calificar
            </button>
        </form>

        <!-- Contenedor para los resultados (oculto por defecto) -->
        <div id="results-container" class="mt-12 p-6 border-t-4 border-blue-500 rounded-lg bg-gray-50 hidden">
            <h2 id="results-title" class="text-3xl font-bold text-center mb-6">Resultados</h2>
            <p id="results-summary" class="text-xl text-center font-semibold mb-8"></p>
            
            <!-- Bot√≥n para an√°lisis hol√≠stico de Gemini -->
            <div class="text-center mb-8">
                <button id="gemini-holistic-btn" type="button" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white font-semibold rounded-lg shadow-md hover:from-purple-600 hover:to-blue-600 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-purple-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ‚ú® Analizar mis resultados con IA
                </button>
            </div>

            <!-- Contenedor para la respuesta hol√≠stica de Gemini -->
            <div id="gemini-holistic-results" class="p-5 bg-white rounded-lg shadow-inner border border-gray-200 hidden">
                <!-- El loader o el texto aparecer√°n aqu√≠ -->
            </div>

            <!-- Aqu√≠ se mostrar√° el desglose de respuestas incorrectas -->
            <div id="incorrect-answers" class="space-y-6 mt-8">
                <!-- Contenido din√°mico -->
            </div>
        </div>

    </div>

    <!-- 
      *** CORRECCI√ìN APLICADA ***
      He reemplazado el bloque <style> que usaba '@apply' (de Tailwind) 
      por CSS est√°ndar. El '@apply' no es CSS v√°lido para el navegador 
      y pudo haber causado el error de sintaxis.
    -->
    <style>
        .tab-button {
            margin-bottom: -1px;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            color: rgb(75 85 99); /* text-gray-600 */
            font-weight: 500;
            border-bottom-width: 2px;
            border-color: transparent;
            transition-property: all;
            transition-duration: 200ms;
        }
        .tab-button:hover {
            color: rgb(37 99 235); /* text-blue-600 */
        }
        .tab-button.active-tab {
            color: rgb(29 78 216); /* text-blue-700 */
            border-color: rgb(37 99 235); /* border-blue-600 */
        }
    </style>

    <!-- Modal para Explicaci√≥n Profunda de Gemini (Oculto por defecto) -->
    <div id="explanation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Fondo -->
        <div id="modal-backdrop" class="fixed inset-0 bg-gray-600 bg-opacity-75 transition-opacity"></div>
        
        <!-- Contenido del Modal -->
        <div id="explanation-modal-content" class="relative bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6 sm:p-8 transform scale-95 opacity-0">
            <!-- Cabecera -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-blue-700" id="modal-title">‚ú® Explicaci√≥n Detallada</h3>
                <button id="modal-close-btn" type="button" class="text-gray-400 hover:text-gray-600 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Cuerpo (donde va la respuesta de Gemini) -->
            <div id="modal-body" class="max-h-[60vh] overflow-y-auto pr-2 space-y-4 text-gray-700">
                <!-- El spinner o la respuesta de Gemini ir√°n aqu√≠ -->
            </div>
        </div>
    </div>


    <script>
        // --- BASE DE DATOS DE PREGUNTAS ---
        const quizData = [
            // --- B√ÅSICO ---
            {
                level: 'basic',
                question: '¬øCu√°l es la palabra clave para declarar una variable de tipo texto en C#?',
                options: [
                    'text',
                    'string',
                    'String',
                    'char[]'
                ],
                correctAnswer: 1,
                explanation: 'En C#, el tipo de dato para cadenas de texto es `string` (que es un alias para `System.String`). `char` es para un solo caracter.'
            },
            {
                level: 'basic',
                question: '¬øQu√© operador se utiliza para una comparaci√≥n de igualdad de valor en C#?',
                options: [
                    '=',
                    '==',
                    '===',
                    '.Equals()'
                ],
                correctAnswer: 1,
                explanation: 'El operador `==` se usa para comparar si dos valores son iguales. Un solo `=` es el operador de asignaci√≥n. `===` no existe en C# (es de JavaScript).'
            },
            {
                level: 'basic',
                question: '¬øCu√°l es el punto de entrada principal de una aplicaci√≥n de consola en C#?',
                options: [
                    'public void Start()',
                    'public void main()',
                    'static void Main(string[] args)',
                    'static int Run()'
                ],
                correctAnswer: 2,
                explanation: 'El m√©todo `Main` (con \'M\' may√∫scula) es el punto de entrada est√°ndar. Debe ser `static` y generalmente retorna `void` o `int`.'
            },
            {
                level: 'basic',
                question: '¬øQu√© tipo de dato usar√≠as para almacenar un n√∫mero entero?',
                options: [
                    'float',
                    'int',
                    'double',
                    'bool'
                ],
                correctAnswer: 1,
                explanation: '`int` es el tipo de dato est√°ndar para n√∫meros enteros. `float` y `double` son para decimales, y `bool` es para verdadero/falso.'
            },
            {
                level: 'basic',
                question: '¬øQu√© operador se usa para asignar un valor a una variable?',
                options: [
                    '==',
                    '=',
                    '=>',
                    '!='
                ],
                correctAnswer: 1,
                explanation: 'Un solo `=` se usa para asignar un valor a una variable. `==` es para comparar.'
            },
            {
                level: 'basic',
                question: '¬øQu√© bucle se ejecuta al menos una vez, incluso si la condici√≥n es falsa?',
                options: [
                    'for',
                    'while',
                    'do-while',
                    'foreach'
                ],
                correctAnswer: 2,
                explanation: 'El bucle `do-while` comprueba la condici√≥n *despu√©s* de ejecutar el bloque, asegurando que se ejecute al menos una vez.'
            },
            {
                level: 'basic',
                question: '¬øQu√© palabra clave se usa para declarar un valor que no cambiar√° (una constante)?',
                options: [
                    'const',
                    'static',
                    'final',
                    'readonly'
                ],
                correctAnswer: 0,
                explanation: '`const` declara un valor que no puede ser modificado y se establece en tiempo de compilaci√≥n.'
            },
            {
                level: 'basic',
                question: '¬øCu√°l es el operador para el "NO" l√≥gico?',
                options: [
                    '&&',
                    '||',
                    '!',
                    '~'
                ],
                correctAnswer: 2,
                explanation: 'El operador `!` (signo de exclamaci√≥n) se usa para negar una expresi√≥n booleana (NO l√≥gico). `&&` es Y, `||` es O.'
            },
            {
                level: 'basic',
                question: '¬øC√≥mo se escribe un comentario de una sola l√≠nea en C#?',
                options: [
                    '/* comentario */',
                    '<!-- comentario -->',
                    '// comentario',
                    '# comentario'
                ],
                correctAnswer: 2,
                explanation: '`//` inicia un comentario de una sola l√≠nea. `/* ... */` es para comentarios de m√∫ltiples l√≠neas.'
            },
            {
                level: 'basic',
                question: '¬øQu√© tipo de dato se usa para almacenar un valor de "verdadero" o "falso"?',
                options: [
                    'boolean',
                    'string',
                    'int',
                    'bool'
                ],
                correctAnswer: 3,
                explanation: 'En C#, el tipo de dato booleano (verdadero/falso) se llama `bool`.'
            },
            // --- INTERMEDIO ---
            {
                level: 'intermediate',
                question: '¬øQu√© palabra clave se usa para definir una clase que no puede ser instanciada directamente?',
                options: [
                    'static',
                    'abstract',
                    'sealed',
                    'private'
                ],
                correctAnswer: 1,
                explanation: 'Una clase `abstract` no puede ser instanciada. Sirve como clase base para que otras clases hereden de ella.'
            },
            {
                level: 'intermediate',
                question: '¬øQu√© es LINQ?',
                options: [
                    'Una librer√≠a para conectar a bases de datos SQL.',
                    'Un lenguaje de marcado para interfaces de usuario.',
                    'Una caracter√≠stica de C# que a√±ade capacidades de consulta de datos a .NET.',
                    'Un tipo de bucle `for` avanzado.'
                ],
                correctAnswer: 2,
                explanation: 'LINQ significa "Language-Integrated Query" (Consulta Integrada en el Lenguaje). Permite escribir consultas sobre colecciones de objetos, bases de datos, XML, etc.'
            },
            {
                level: 'intermediate',
                question: '¬øCu√°l es la diferencia principal entre una `interface` y una `abstract class`?',
                options: [
                    'Una interface no puede tener m√©todos, solo propiedades.',
                    'Una clase puede heredar de m√∫ltiples interfaces, pero solo de una clase abstracta.',
                    'Una clase abstracta no puede tener constructores.',
                    'Las interfaces se usan para UI y las clases abstractas para l√≥gica.'
                ],
                correctAnswer: 1,
                explanation: 'C# no admite la herencia m√∫ltiple de clases. Sin embargo, una clase s√≠ puede implementar m√∫ltiples interfaces. Esta es una diferencia fundamental.'
            },
            {
                level: 'intermediate',
                question: '¬øCu√°l es la diferencia clave entre los par√°metros `ref` y `out`?',
                options: [
                    'La variable `ref` debe ser inicializada antes de pasarse, la variable `out` no.',
                    'La variable `out` debe ser inicializada antes de pasarse, la variable `ref` no.',
                    'Ambos son id√©nticos en su funcionamiento.',
                    '`ref` es para tipos de valor, `out` es para tipos de referencia.'
                ],
                correctAnswer: 0,
                explanation: 'Una variable pasada como `ref` debe tener un valor. Una variable pasada como `out` no necesita estar inicializada, pero *debe* ser asignada dentro del m√©todo.'
            },
            {
                level: 'intermediate',
                question: '¬øQu√© palabra clave se usa para evitar que una clase pueda ser heredada?',
                options: [
                    'abstract',
                    'virtual',
                    'sealed',
                    'private'
                ],
                correctAnswer: 2,
                explanation: '`sealed` (sellada) previene que otras clases hereden de ella. `abstract` fuerza la herencia.'
            },
            {
                level: 'intermediate',
                question: '¬øQu√© es el "Garbage Collector" (Recolector de Basura)?',
                options: [
                    'Un compilador de c√≥digo.',
                    'Un sistema para gestionar la memoria no utilizada autom√°ticamente.',
                    'Un depurador de errores en tiempo de ejecuci√≥n.',
                    'Una herramienta de seguridad de C#.'
                ],
                correctAnswer: 1,
                explanation: 'El Recolector de Basura (GC) es un proceso autom√°tico del CLR que libera la memoria ocupada por objetos que ya no est√°n en uso.'
            },
            {
                level: 'intermediate',
                question: '¬øQu√© es el "boxing" en C#?',
                options: [
                    'Convertir un tipo de valor (ej. `int`) a un tipo de referencia (`object`).',
                    'Proteger variables con un bloque `try-catch`.',
                    'Empaquetar un proyecto para distribuci√≥n.',
                    'Crear un constructor para una clase.'
                ],
                correctAnswer: 0,
                explanation: 'Boxing es el proceso de convertir un tipo de valor (como `int`, `struct`) a un tipo de referencia `object`. "Unboxing" es el proceso inverso.'
            },
            {
                level: 'intermediate',
                question: '¬øQu√© hace la palabra clave `virtual` en un m√©todo?',
                options: [
                    'Lo hace obligatorio de implementar en clases derivadas.',
                    'Permite que sea sobrescrito (`override`) en una clase derivada.',
                    'Lo convierte en un m√©todo est√°tico.',
                    'Lo oculta de otras clases fuera del ensamblado.'
                ],
                correctAnswer: 1,
                explanation: 'Un m√©todo `virtual` en una clase base puede ser reimplementado en una clase derivada usando la palabra clave `override`.'
            },
            {
                level: 'intermediate',
                question: '¬øQu√© es un `enum`?',
                options: [
                    'Un tipo de error de compilaci√≥n.',
                    'Un tipo de dato especial que consiste en un conjunto de constantes con nombre.',
                    'Un alias para `System.Int32`.',
                    'Un bucle para enumerar colecciones (similar a foreach).'
                ],
                correctAnswer: 1,
                explanation: 'Una enumeraci√≥n (`enum`) se usa para definir un conjunto de constantes num√©ricas con nombres descriptivos (ej. `enum Nivel { Bajo, Medio, Alto }`).'
            },
            {
                level: 'intermediate',
                question: '¬øCu√°ndo es preferible usar `StringBuilder` en lugar de `string`?',
                options: [
                    'Siempre, `StringBuilder` es m√°s r√°pido.',
                    'Para almacenar contrase√±as de forma segura.',
                    'Cuando se necesita modificar una cadena muchas veces (ej. en un bucle).',
                    'Para comparar dos cadenas ignorando may√∫sculas/min√∫sculas.'
                ],
                correctAnswer: 2,
                explanation: 'Concatenar `string` repetidamente crea muchos objetos nuevos. `StringBuilder` modifica una cadena interna de forma eficiente.'
            },
            // --- AVANZADO ---
            {
                level: 'advanced',
                question: '¬øQu√© dos palabras clave son fundamentales para la programaci√≥n as√≠ncrona en C#?',
                options: [
                    'async / await',
                    'try / catch',
                    'delegate / event',
                    'using / new'
                ],
                correctAnswer: 0,
                explanation: '`async` marca un m√©todo como as√≠ncrono, y `await` se usa dentro de ese m√©todo para esperar a que una tarea (Task) se complete sin bloquear el hilo principal.'
            },
            {
                level: 'advanced',
                question: '¬øQu√© es un `delegate` (delegado) en C#?',
                options: [
                    'Un evento que se dispara autom√°ticamente.',
                    'Un tipo de dato que encapsula una referencia a un m√©todo (similar a un puntero a funci√≥n).',
                    'Una clase que gestiona la memoria autom√°ticamente.',
                    'Una forma de crear hilos (threads) de forma segura.'
                ],
                correctAnswer: 1,
                explanation: 'Un delegado es un tipo de referencia que puede usarse para encapsular un m√©todo con una firma (par√°metros y tipo de retorno) espec√≠fica.'
            },
            {
                level: 'advanced',
                question: '¬øPara qu√© se utiliza principalmente la sentencia `using` en C# (no la directiva `using` de namespaces)?',
                options: [
                    'Para importar librer√≠as externas.',
                    'Para crear un alias de un tipo de dato.',
                    'Para asegurar que los objetos que implementan `IDisposable` liberen sus recursos.',
                    'Para declarar variables locales que solo existen en ese bloque.'
                ],
                correctAnswer: 2,
                explanation: 'La sentencia `using (var obj = ...)` asegura que el m√©todo `Dispose()` del objeto se llame autom√°ticamente al salir del bloque `using`.'
            },
            {
                level: 'advanced',
                question: '¬øQu√© es una Expresi√≥n Lambda?',
                options: [
                    'Una forma de declarar constantes globales.',
                    'Un m√©todo an√≥nimo escrito de forma corta (ej. `x => x * 2`).',
                    'Un tipo de consulta LINQ obligatorio.',
                    'Un error de compilaci√≥n relacionado con tipos.'
                ],
                correctAnswer: 1,
                explanation: 'Una expresi√≥n lambda (ej. `x => x * 2`) es una sintaxis corta para escribir un m√©todo an√≥nimo, muy usada en LINQ y delegados.'
            },
            {
                level: 'advanced',
                question: '¬øQu√© es la Inyecci√≥n de Dependencias (DI)?',
                options: [
                    'Un patr√≥n donde un objeto recibe sus dependencias desde una fuente externa.',
                    'Una forma de "inyectar" SQL malicioso en una aplicaci√≥n.',
                    'Un m√©todo para depurar c√≥digo en tiempo real.',
                    'Una caracter√≠stica exclusiva de LINQ para filtrar datos.'
                ],
                correctAnswer: 0,
                explanation: 'La Inyecci√≥n de Dependencias es un patr√≥n de dise√±o que ayuda a desacoplar el c√≥digo, facilitando las pruebas y el mantenimiento.'
            },
            {
                level: 'advanced',
                question: '¬øQu√© hace la palabra clave `yield return`?',
                options: [
                    'Devuelve un valor y termina la ejecuci√≥n del m√©todo inmediatamente.',
                    'Crea un iterador personalizado que devuelve elementos uno por uno (evaluaci√≥n perezosa).',
                    'Inicia una nueva tarea (`Task`) as√≠ncrona.',
                    'Lanza una excepci√≥n de tipo `YieldException`.'
                ],
                correctAnswer: 1,
                explanation: '`yield return` se usa en m√©todos que devuelven `IEnumerable`. Permite al m√©todo "pausar" y devolver un valor, y continuar desde ese punto la pr√≥xima vez.'
            },
            {
                level: 'advanced',
                question: '¬øCu√°l es la diferencia principal entre un `struct` y una `class`?',
                options: [
                    'No hay diferencia, son sin√≥nimos.',
                    '`struct` es un tipo de valor, `class` es un tipo de referencia.',
                    '`class` no puede tener m√©todos, `struct` s√≠.',
                    '`struct` solo puede almacenar n√∫meros.'
                ],
                correctAnswer: 1,
                explanation: 'Los `struct` son tipos de valor (se copian por valor) y generalmente se almacenan en el stack. Las `class` son tipos de referencia (se copian por referencia) y se almacenan en el heap.'
            },
            {
                level: 'advanced',
                question: '¬øQu√© es un delegado `Action<T>`?',
                options: [
                    'Un delegado que toma un par√°metro `T` y devuelve un `bool`.',
                    'Un delegado que toma un par√°metro `T` y no devuelve ning√∫n valor (`void`).',
                    'Un delegado que no toma par√°metros y devuelve un `T`.',
                    'Una clase para animaciones de interfaz de usuario.'
                ],
                correctAnswer: 1,
                explanation: '`Action` es un delegado gen√©rico para m√©todos que no devuelven valor (`void`). `Action<T>` toma un par√°metro.'
            },
            {
                level: 'advanced',
                question: '¬øQu√© es un delegado `Func<T, TResult>`?',
                options: [
                    'Un delegado que toma un par√°metro `T` y devuelve un valor `TResult`.',
                    'Un delegado que no toma par√°metros y devuelve `void`.',
                    'Un delegado que toma `T` y `TResult` y devuelve `void`.',
                    'Una funci√≥n matem√°tica especial en `System.Math`.'
                ],
                correctAnswer: 0,
                explanation: '`Func` es un delegado gen√©rico para m√©todos que S√ç devuelven un valor. El *√∫ltimo* par√°metro gen√©rico es siempre el tipo de retorno.'
            },
            {
                level: 'advanced',
                question: '¬øQu√© es `Task.Run()`?',
                options: [
                    'Una forma de ejecutar una tarea (`Task`) de forma s√≠ncrona en el hilo principal.',
                    'Un atajo para poner en cola un trabajo en el `ThreadPool` (ejecuci√≥n as√≠ncrona).',
                    'Una funci√≥n para pausar la ejecuci√≥n del programa.',
                    'Un m√©todo obsoleto reemplazado por `Task.Factory.StartNew()`.'
                ],
                correctAnswer: 1,
                explanation: '`Task.Run()` es la forma moderna y preferida de ejecutar una operaci√≥n en un hilo del ThreadPool, permitiendo que la UI (u otro hilo) no se bloquee.'
            }
        ];

        let aiQuestionsLoaded = false; // Flag global para evitar recargas

        // --- FUNCIONES DE GEMINI API ---

        /**
         * Devuelve la API key incrustada.
         * ADVERTENCIA: ¬°Esto no es seguro para producci√≥n! La clave es visible en el c√≥digo.
         */
        function getApiKey() {
            return "AIzaSyC6x340B9SZZEy8BWrInDSl2gYJuV_zicc";
        }

        /**
         * Peque√±a utilidad para pausar la ejecuci√≥n (usada en reintentos).
         */
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /**
         * Llama a la API de Gemini con l√≥gica de reintentos (exponential backoff).
         */
        async function callGeminiWithRetries(prompt, systemInstruction, retries = 3, delay = 1000) {
            const apiKey = getApiKey();
            if (!apiKey) {
                // No mostramos alert() aqu√≠ para no ser intrusivos, la UI lo manejar√°.
                console.warn("Se intent√≥ llamar a Gemini sin API key.");
                return "Por favor, ingresa tu API Key de Google AI Studio para usar esta funci√≥n.";
            }

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                }
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Error en la API de Gemini:", errorData);
                        throw new Error(`Error de API: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        // Manejar respuesta vac√≠a o mal formada
                        if (result.promptFeedback && result.promptFeedback.blockReason) {
                            console.error("Llamada bloqueada:", result.promptFeedback.blockReason);
                            return `La solicitud fue bloqueada por razones de seguridad: ${result.promptFeedback.blockReason}`;
                        }
                        throw new Error("Respuesta inesperada o vac√≠a de la API de Gemini.");
                    }

                } catch (error) {
                    console.error(`Intento ${i + 1} fallido:`, error);
                    if (i === retries - 1) {
                        // √öltimo intento fallido
                        return "Lo sentimos, hubo un error al contactar a la IA. Revisa tu API key y la consola para m√°s detalles.";
                    }
                    // Esperar antes de reintentar
                    await sleep(delay * Math.pow(2, i));
                }
            }
            return "Error desconocido despu√©s de m√∫ltiples intentos."; // No deber√≠a llegar aqu√≠
        }

        /**
         * Llama a la API de Gemini solicitando una respuesta JSON estructurada.
         */
        async function callGeminiForJson(prompt, systemInstruction, schema, retries = 3, delay = 1000) {
            const apiKey = getApiKey();
            if (!apiKey) {
                console.warn("Se intent√≥ llamar a Gemini sin API key.");
                return null;
            }

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Error en la API de Gemini (JSON):", errorData);
                        throw new Error(`Error de API: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                        const textResponse = result.candidates[0].content.parts[0].text;
                        return JSON.parse(textResponse); // Devuelve el objeto JSON parseado
                    } else {
                        if (result.promptFeedback && result.promptFeedback.blockReason) {
                            console.error("Llamada bloqueada:", result.promptFeedback.blockReason);
                        }
                        throw new Error("Respuesta inesperada o vac√≠a de la API de Gemini (JSON).");
                    }

                } catch (error) {
                    console.error(`Intento ${i + 1} fallido (JSON):`, error);
                    if (i === retries - 1) {
                        return null; // Fall√≥ despu√©s de todos los reintentos
                    }
                    await sleep(delay * Math.pow(2, i));
                }
            }
            return null; // Fall√≥
        }


        // --- FUNCIONES DEL QUIZ (EXISTENTES) ---

        /**
         * Configura la l√≥gica para cambiar entre pesta√±as.
         */
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Obtener el ID del contenido a mostrar desde 'data-target'
                    const targetId = button.getAttribute('data-target');
                    
                    // Actualizar botones (quitar 'active' de todos, poner en el clickeado)
                    tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                    button.classList.add('active-tab');

                    // Ocultar todo el contenido
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });

                    // Mostrar el contenido objetivo
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }

                    // --- L√ìGICA DE IA A√ëADIDA ---
                    // Si es la pesta√±a de IA y no se ha cargado...
                    if (targetId === 'ai-quiz' && !aiQuestionsLoaded) {
                        aiQuestionsLoaded = true; // Marcar como cargando (para evitar dobles clics)
                        loadAIQuestions(); // Llamar a la funci√≥n de generaci√≥n
                    }
                });
            });
        }

        /**
         * REFACTORIZACI√ìN: Crea el DOM para una sola pregunta.
         * Usado por loadQuiz() y loadAIQuestions().
         * @param {object} questionData - El objeto de la pregunta.
         * @param {number} index - El √≠ndice de la pregunta en el array global quizData.
         * @param {number} questionNumber - El n√∫mero a mostrar (1, 2, 3...).
         * @returns {HTMLElement} El elemento div de la pregunta.
         */
        function createQuestionElement(questionData, index, questionNumber) {
            // 1. Crear el contenedor principal de la pregunta
            const questionElement = document.createElement('div');
            questionElement.className = 'p-6 border border-gray-200 rounded-lg shadow-sm bg-white';

            // 2. Crear el texto de la pregunta
            const questionText = document.createElement('p');
            questionText.className = 'text-lg font-medium text-gray-800 mb-5';
            questionText.textContent = `${questionNumber}. ${questionData.question}`;
            questionElement.appendChild(questionText);

            // 3. Crear el contenedor de opciones
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'space-y-3';

            // 4. Crear cada opci√≥n (label, input, span)
            questionData.options.forEach((option, optionIndex) => {
                const label = document.createElement('label');
                label.className = 'radio-label block w-full p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition-all duration-200';

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = `q${index}`; // El 'name' agrupa los radio buttons (usa el √≠ndice global)
                input.value = optionIndex;
                input.className = 'mr-3 text-blue-600 focus:ring-blue-500';

                const span = document.createElement('span');
                span.className = 'text-gray-700';
                span.textContent = option;

                label.appendChild(input);
                label.appendChild(span);
                optionsContainer.appendChild(label);
            });

            questionElement.appendChild(optionsContainer);
            return questionElement;
        }


        /**
         * Carga las preguntas est√°ticas en el DOM.
         */
        function loadQuiz() {
            const containers = {
                basic: document.getElementById('basic-quiz'),
                intermediate: document.getElementById('intermediate-quiz'),
                advanced: document.getElementById('advanced-quiz')
            };
            
            let counters = { basic: 1, intermediate: 1, advanced: 1 };

            quizData.forEach((questionData, index) => {
                const container = containers[questionData.level];
                if (!container) return;

                const questionNumber = counters[questionData.level]++;
                const questionElement = createQuestionElement(questionData, index, questionNumber);
                container.appendChild(questionElement);
            });
        }

        /**
         * NUEVA FUNCI√ìN: Llama a la IA para generar 5 preguntas y las a√±ade al DOM.
         */
        async function loadAIQuestions() {
            const loader = document.getElementById('ai-quiz-loader');
            const container = document.getElementById('ai-quiz');

            // 1. Definir el esquema JSON que esperamos de la IA
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        question: { type: "STRING" },
                        options: { type: "ARRAY", items: { type: "STRING" } },
                        correctAnswer: { type: "NUMBER" },
                        explanation: { type: "STRING" }
                    },
                    required: ["question", "options", "correctAnswer", "explanation"]
                }
            };

            // 2. Definir los prompts para la IA
            const systemPrompt = "Eres un generador de ex√°menes de C#. Debes devolver *√∫nicamente* un array JSON que coincida con el esquema proporcionado, con 5 preguntas de C#. Aseg√∫rate de que las opciones tengan 4 elementos.";
            const userPrompt = "Genera 5 preguntas de examen sobre C#, de dificultad mixta (b√°sica a avanzada). Deben ser preguntas de opci√≥n m√∫ltiple con 4 opciones. Proporciona el √≠ndice de la respuesta correcta (0-3) y una breve explicaci√≥n para cada una.";

            try {
                // 3. Llamar a la IA
                const generatedQuestions = await callGeminiForJson(userPrompt, systemPrompt, schema);

                if (generatedQuestions && Array.isArray(generatedQuestions) && generatedQuestions.length > 0) {
                    loader.style.display = 'none'; // Ocultar el loader
                    
                    // 4. Renderizar las preguntas
                    generatedQuestions.forEach((qData, i) => {
                        // Validar que la pregunta tenga 4 opciones (la IA a veces se equivoca)
                        if (!qData.options || qData.options.length !== 4) {
                            console.warn("Pregunta de IA omitida, no tiene 4 opciones:", qData);
                            return; // Saltar esta pregunta
                        }

                        const newIndex = quizData.length; // Obtener el nuevo √≠ndice (ej. 30, 31, 32...)
                        qData.level = 'ai'; // Asignar un nivel para referencia
                        
                        quizData.push(qData); // <-- A√ëADIR LA PREGUNTA AL ARRAY GLOBAL
                        
                        // Usar la funci√≥n refactorizada para crear el elemento
                        const questionElement = createQuestionElement(qData, newIndex, i + 1); // i+1 es (1, 2, 3...)
                        
                        container.appendChild(questionElement);
                    });
                } else {
                    throw new Error("La IA no devolvi√≥ un array v√°lido.");
                }

            } catch (error) {
                console.error("Error al cargar preguntas de IA:", error);
                loader.innerHTML = '<p class="text-red-600 text-center font-semibold">Hubo un error al generar las preguntas. Por favor, recarga la p√°gina e int√©ntalo de nuevo.</p>';
            }
        }


        /**
         * Maneja el env√≠o del formulario, califica y muestra los resultados.
         */
        function handleSubmit(event) {
            event.preventDefault(); 

            const quizForm = document.getElementById('quiz-form');
            const resultsContainer = document.getElementById('results-container');
            const resultsSummary = document.getElementById('results-summary');
            const incorrectAnswersDiv = document.getElementById('incorrect-answers');
            const holisticButton = document.getElementById('gemini-holistic-btn');
            const holisticResults = document.getElementById('gemini-holistic-results');

            // Limpiar resultados anteriores
            incorrectAnswersDiv.innerHTML = '';
            holisticResults.innerHTML = '';
            holisticResults.classList.add('hidden');
            holisticButton.style.display = 'block'; // Mostrar bot√≥n por defecto

            const formData = new FormData(quizForm);
            let score = 0;
            let questionsAnswered = 0; // <-- NUEVA VARIABLE
            let incorrectHtml = '';
            let incorrectQuestionsForAI = []; // Array para enviar a Gemini

            quizData.forEach((questionData, index) => {
                const userAnswer = formData.get(`q${index}`);

                // *** L√ìGICA MODIFICADA ***
                // Solo procesamos la pregunta si fue respondida
                if (userAnswer !== null) {
                    questionsAnswered++; // Contar como pregunta intentada
                    const isCorrect = parseInt(userAnswer) === questionData.correctAnswer;

                    if (isCorrect) {
                        score++;
                    } else {
                        // Es incorrecta, mostrar en resultados
                        const correctAnswerText = questionData.options[questionData.correctAnswer];
                        const userAnswerText = questionData.options[parseInt(userAnswer)];
                        
                        // Almacenar info para el an√°lisis hol√≠stico de IA
                        incorrectQuestionsForAI.push({
                            question: questionData.question,
                            yourAnswer: userAnswerText,
                            correctAnswer: correctAnswerText,
                            explanation: questionData.explanation
                        });

                        // A√±adimos el bot√≥n de "Explicar m√°s a fondo" con data-attributes
                        incorrectHtml += `
                            <div class="p-5 border border-red-300 rounded-lg bg-red-50">
                                <p class="font-semibold text-red-800 text-lg">Pregunta: ${questionData.question}</p>
                                <p class="mt-2 text-red-700">
                                    <span class="font-medium">Tu respuesta:</span> ${userAnswerText}
                                </p>
                                <p class="mt-1 text-green-700">
                                    <span class="font-medium">Respuesta correcta:</span> ${correctAnswerText}
                                </p>
                                <div class="mt-3 pt-3 border-t border-red-200">
                                    <p class="text-sm text-gray-800 font-medium">Explicaci√≥n:</p>
                                    <p class="text-sm text-gray-700 mt-1">${questionData.explanation}</p>
                                </div>
                                <!-- Bot√≥n de Gemini para explicaci√≥n profunda -->
                                <div class="mt-4 text-right">
                                    <button type="button" 
                                            class="gemini-explain-btn px-4 py-2 bg-blue-100 text-blue-700 text-sm font-medium rounded-md hover:bg-blue-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                            data-question="${encodeURIComponent(questionData.question)}"
                                            data-explanation="${encodeURIComponent(questionData.explanation)}"
                                            disabled>
                                        ‚ú® Explicar m√°s a fondo
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }
                // Si userAnswer es null, simplemente no hace nada con esa pregunta.
            });

            // *** L√ìGICA DE RESULTADOS MEJORADA ***
            if (questionsAnswered === 0) {
                resultsSummary.textContent = "No has respondido ninguna pregunta.";
                incorrectAnswersDiv.innerHTML = '<p class="text-center text-lg text-gray-600">Completa al menos una secci√≥n para ver tus resultados.</p>';
                holisticButton.style.display = 'none'; // Ocultar bot√≥n de IA
            } else {
                // Mostrar puntuaci√≥n basada en las respondidas
                resultsSummary.textContent = `Tu puntuaci√≥n: ${score} de ${questionsAnswered} respondidas`;
                
                if (incorrectHtml) {
                    incorrectAnswersDiv.innerHTML = `<h3 class="text-xl font-semibold mb-4 text-red-700">Repaso de respuestas incorrectas:</h3>` + incorrectHtml;
                    holisticButton.style.display = 'block'; // Mostrar bot√≥n IA
                } else {
                    // Todas las respondidas fueron correctas
                    incorrectAnswersDiv.innerHTML = `<p class="text-center text-lg font-medium text-green-600">¬°Felicidades! ¬°Todas las (${questionsAnswered}) preguntas que respondiste son correctas!</p>`;
                    holisticButton.style.display = 'none'; // Ocultar bot√≥n de IA
                }
            }

            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Almacenar las preguntas incorrectas para el bot√≥n hol√≠stico
            holisticButton.dataset.incorrectData = JSON.stringify(incorrectQuestionsForAI);
            
            // Habilitar botones de IA si hay una API key
            checkApiKeyAndEnableButtons();
        }

        /**
         * Habilita/deshabilita los botones de IA basado en si hay una API key.
         */
        function checkApiKeyAndEnableButtons() {
            const apiKey = getApiKey();
            const disabled = !apiKey;
            
            const holisticButton = document.getElementById('gemini-holistic-btn');
            if (holisticButton) {
                holisticButton.disabled = disabled;
            }
            
            document.querySelectorAll('.gemini-explain-btn').forEach(btn => {
                btn.disabled = disabled;
            });

            // Si se deshabilita, mostrar un tooltip o mensaje
            const apiKeyInput = document.getElementById('api-key');
            if(disabled) {
                if (apiKeyInput) apiKeyInput.classList.add('border-red-500'); // Resaltar campo
            } else {
                if (apiKeyInput) apiKeyInput.classList.remove('border-red-500');
            }
        }

        // --- MANEJADORES DE MODAL Y GEMINI ---

        function showModal(title, content) {
            const modal = document.getElementById('explanation-modal');
            const modalContent = document.getElementById('explanation-modal-content');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            
            modal.classList.remove('hidden');
            // Peque√±o delay para la animaci√≥n de entrada
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('explanation-modal');
            const modalContent = document.getElementById('explanation-modal-content');
            
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            modal.classList.remove('opacity-100');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Esperar a que termine la animaci√≥n
        }

        /**
         * Formatea la respuesta de texto plano de Gemini a HTML seguro.
         * Reemplaza \n con <br>
         * Envuelve bloques de c√≥digo (```csharp ... ```) en <pre><code>
         */
        function formatGeminiResponse(text) {
            // Escapar HTML b√°sico para seguridad
            let safeText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Formatear bloques de c√≥digo
            safeText = safeText.replace(/```csharp\n([\s\S]*?)```/g, 
                (match, code) => `<pre class="bg-gray-900 text-white p-4 rounded-md mt-4 mb-4 overflow-x-auto"><code>${code.trim()}</code></pre>`
            );
            
            // Formatear bloques de c√≥digo gen√©ricos
            safeText = safeText.replace(/```\n([\s\S]*?)```/g, 
                (match, code) => `<pre class="bg-gray-900 text-white p-4 rounded-md mt-4 mb-4 overflow-x-auto"><code>${code.trim()}</code></pre>`
            );

            // Reemplazar saltos de l√≠nea por <br> fuera de los bloques <pre>
            const parts = safeText.split(/(<pre[\s\S]*?<\/pre>)/);
            let html = '';
            for (let i = 0; i < parts.length; i++) {
                if (i % 2 === 0) {
                    // Es texto normal
                    html += parts[i].replace(/\n/g, '<br>');
                } else {
                    // Es un bloque <pre>
                    html += parts[i];
                }
            }

            return html;
        }


        // --- EVENT LISTENERS ---
        // Esperar a que el HTML est√© cargado
        document.addEventListener('DOMContentLoaded', () => {
            setupTabs(); // Configurar la l√≥gica de las pesta√±as
            loadQuiz();  // Cargar las preguntas en el DOM
            
            // Asignar la funci√≥n de calificar al env√≠o del formulario
            document.getElementById('quiz-form').addEventListener('submit', handleSubmit);

            // Listener para el input de API key
            const apiKeyInput = document.getElementById('api-key');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('input', checkApiKeyAndEnableButtons);
            }

            // Listeners para cerrar el modal
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            document.getElementById('modal-backdrop').addEventListener('click', closeModal);

            // --- Listener para el bot√≥n de "An√°lisis Hol√≠stico" (Feature 1) ---
            document.getElementById('gemini-holistic-btn').addEventListener('click', async (event) => {
                const button = event.currentTarget;
                const resultsDiv = document.getElementById('gemini-holistic-results');
                
                if (!getApiKey()) {
                    alert("Por favor, ingresa tu API Key para usar esta funci√≥n.");
                    return;
                }
                
                const incorrectData = JSON.parse(button.dataset.incorrectData || '[]');
                if (incorrectData.length === 0) return;

                resultsDiv.innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div><p class="ml-4 text-gray-600">Analizando tus respuestas...</p></div>';
                resultsDiv.classList.remove('hidden');
                button.disabled = true;

                const systemPrompt = "Eres un tutor de programaci√≥n C# amigable y experto. Tu tono es alentador y constructivo. Analiza las respuestas incorrectas del estudiante (pregunta, su respuesta, la correcta) y proporciona un resumen conciso (m√°ximo 3 p√°rrafos) de sus fortalezas y debilidades. USA MARKDOWN para formatear (ej. **negritas**, *cursivas*). Concluye sugiriendo 2-3 temas clave en los que deber√≠a enfocarse para mejorar, usando una lista con guiones.";
                
                let userPrompt = "Hola, he fallado estas preguntas en un examen de C#:\n\n";
                incorrectData.forEach((item, index) => {
                    userPrompt += `Error ${index + 1}:\n`;
                    userPrompt += `- Pregunta: ${item.question}\n`;
                    userPrompt += `- Mi respuesta: ${item.yourAnswer}\n`;
                    userPrompt += `- Respuesta correcta: ${item.correctAnswer}\n\n`;
                });
                userPrompt += "Basado en estos errores, ¬øcu√°l es tu an√°lisis de mis conocimientos y qu√© deber√≠a estudiar?";

                const response = await callGeminiWithRetries(userPrompt, systemPrompt);
                
                // Usamos la nueva funci√≥n de formateo
                resultsDiv.innerHTML = `<div class="prose prose-blue max-w-none">${formatGeminiResponse(response)}</div>`;
                button.disabled = false;
            });

            // --- Listener delegado para "Explicar m√°s fondo" (Feature 2) ---
            document.addEventListener('click', async (event) => {
                const button = event.target.closest('.gemini-explain-btn');
                if (button) {
                    
                    if (!getApiKey()) {
                        alert("Por favor, ingresa tu API Key para usar esta funci√≥n.");
                        return;
                    }

                    const question = decodeURIComponent(button.dataset.question);
                    const explanation = decodeURIComponent(button.dataset.explanation);

                    // Mostrar modal con loader
                    showModal('‚ú® Explicaci√≥n Detallada', '<div class="flex justify-center items-center p-8"><div class="loader"></div><p class="ml-4 text-gray-600">Generando explicaci√≥n...</p></div>');

                    const systemPrompt = "Eres un tutor de programaci√≥n C#. Explica el siguiente concepto de forma clara, detallada y amigable, como si se lo explicaras a un principiante. Proporciona un ejemplo de c√≥digo simple y bien comentado para ilustrar tu explicaci√≥n. USA MARKDOWN para formatear (especialmente bloques de c√≥digo ```csharp ... ```).";
                    const userPrompt = `Necesito una explicaci√≥n m√°s profunda sobre este tema.\n\NLa pregunta del examen fue:\n"${question}"\n\NLa explicaci√≥n breve fue:\n"${explanation}"\n\NPor favor, dame una explicaci√≥n m√°s detallada y un ejemplo de c√≥digo pr√°ctico.`;

                    const response = await callGeminiWithRetries(userPrompt, systemPrompt);
                    
                    // Usamos la nueva funci√≥n de formateo
                    document.getElementById('modal-body').innerHTML = `<div class="prose prose-blue max-w-none">${formatGeminiResponse(response)}</div>`;
                }
            });

        });

    </script>
</body>
</html>